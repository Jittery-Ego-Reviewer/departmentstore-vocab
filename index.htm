<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¾è²¨å…¬å¸å°‹å¯¶éŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation; /* Prevents double-tap zoom on mobile */
        }
        .item-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .item-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .item-card.selected {
            transform: scale(0.9);
            border-color: #4ade80; /* green-400 */
            opacity: 0.5;
        }
        .elevator-button.active {
            background-color: #f59e0b; /* amber-500 */
            color: white;
            font-weight: bold;
        }
        .shelf {
            background-image: url('https://placehold.co/100x20/deb887/deb887?text=shelf');
            background-repeat: repeat-x;
            background-size: contain;
            border-bottom: 5px solid #A0522D;
        }
        .hidden {
            display: none;
        }
        /* Custom animation for score feedback */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .score-pop {
            animation: pop 0.3s ease-in-out;
        }
        /* Hint animation */
        @keyframes vibrate {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        .vibrate-hint {
            animation: vibrate 0.5s ease-in-out 2; /* Vibrate for 1 second */
            border: 2px solid #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-amber-50 antialiased text-gray-800">

    <div id="game-container" class="max-w-7xl mx-auto p-2 sm:p-4 min-h-screen flex flex-col">

        <!-- Start Screen -->
        <div id="start-screen" class="flex flex-col items-center justify-center text-center h-full flex-grow">
            <h1 class="text-4xl sm:text-6xl font-bold text-amber-600 mb-4">ç™¾è²¨å…¬å¸å°‹å¯¶éŠæˆ²</h1>
            <p class="text-lg sm:text-xl text-gray-600 mb-8">é¸æ“‡é›£åº¦é–‹å§‹éŠæˆ²ï¼</p>
            <div class="space-y-4">
                <button id="start-easy" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">ç°¡å–®æ¨¡å¼</button>
                <button id="start-difficult" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">å›°é›£æ¨¡å¼</button>
            </div>
             <div class="mt-8 p-4 bg-white rounded-lg shadow-md text-left max-w-md">
                <h2 class="font-bold text-lg mb-2 text-amber-700">éŠæˆ²ç©æ³•ï¼š</h2>
                <p><span class="font-bold text-green-600">ç°¡å–®æ¨¡å¼ï¼š</span>æ ¹æ“šè³¼ç‰©æ¸…å–®ï¼Œåˆ°ä¸åŒæ¨“å±¤æŠŠè²¨å“æ”¾å…¥è³¼ç‰©è»Šã€‚</p>
                <p><span class="font-bold text-red-600">å›°é›£æ¨¡å¼ï¼š</span>é™¤äº†å®Œæˆè³¼ç‰©æ¸…å–®ï¼Œé‚„è¦æ‰¾å‡ºæ¯å±¤æ¨“æ”¾éŒ¯äº†çš„è²¨å“ï¼</p>
            </div>
        </div>

        <!-- Main Game Screen -->
        <div id="main-game" class="hidden flex-grow flex-col">
            <!-- Header -->
            <header class="bg-white rounded-lg shadow-md p-2 sm:p-4 mb-4">
                <div class="flex flex-col sm:flex-row justify-between items-center">
                    <div id="shopping-list-container" class="mb-2 sm:mb-0">
                        <h2 class="text-xl sm:text-2xl font-bold text-amber-700">è³¼ç‰©æ¸…å–®</h2>
                        <p id="list-owner" class="text-gray-600"></p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-center">
                            <span class="text-lg font-bold text-blue-600">åˆ†æ•¸</span>
                            <div id="score" class="text-3xl font-bold bg-blue-100 text-blue-800 px-4 py-1 rounded-lg">0</div>
                        </div>
                        <div class="text-center">
                            <span class="text-lg font-bold text-purple-600">å›åˆ</span>
                            <div id="round" class="text-3xl font-bold bg-purple-100 text-purple-800 px-4 py-1 rounded-lg">1 / 8</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Game Area -->
            <div class="flex-grow flex flex-col md:flex-row gap-4">
                <!-- Elevator Panel -->
                <aside class="w-full md:w-48 bg-white rounded-lg shadow-md p-4 flex md:flex-col justify-start items-center gap-2">
                    <h3 class="hidden md:block text-xl font-bold mb-4 text-center text-gray-700">é›»æ¢¯</h3>
                    <div id="elevator-buttons" class="grid grid-cols-3 sm:grid-cols-6 md:grid-cols-1 w-full gap-2">
                        <!-- Buttons will be generated by JS -->
                    </div>
                </aside>

                <!-- Department Store -->
                <main class="flex-grow bg-white rounded-lg shadow-md p-4">
                    <div id="department-floor" class="h-full">
                        <!-- Floor content will be generated by JS -->
                    </div>
                </main>

                <!-- Shopping Cart -->
                 <aside class="w-full md:w-64 bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-xl font-bold mb-4 text-center text-green-700">
                        <span class="align-middle">ğŸ›’ è³¼ç‰©è»Š</span>
                    </h3>
                    <div id="shopping-cart" class="space-y-2 h-64 md:h-auto overflow-y-auto bg-gray-50 p-2 rounded-lg">
                        <p class="text-gray-500 text-center italic">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
                    </div>
                    <div id="wrong-items-section" class="mt-4 hidden">
                        <h3 class="text-xl font-bold mb-2 text-center text-red-700">ğŸ§ æ‰¾å‡ºçš„éŒ¯è™•</h3>
                        <div id="wrong-items-cart" class="space-y-2 h-32 md:h-auto overflow-y-auto bg-gray-50 p-2 rounded-lg">
                           <p class="text-gray-500 text-center italic">é‚„æœªæ‰¾åˆ°</p>
                        </div>
                    </div>
                </aside>
            </div>

        </div>

        <!-- End Screen -->
        <div id="end-screen" class="hidden flex-col items-center justify-center text-center h-full flex-grow">
            <h1 class="text-5xl font-bold text-amber-600 mb-4">éŠæˆ²çµæŸï¼</h1>
            <p class="text-2xl text-gray-700 mb-4">ä½ çš„æœ€çµ‚åˆ†æ•¸æ˜¯ï¼š</p>
            <div id="final-score" class="text-7xl font-bold text-blue-600 mb-8"></div>
            <button id="restart-game" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">é‡æ–°é–‹å§‹</button>
        </div>

        <!-- Success Modal -->
        <div id="success-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg shadow-2xl text-center transform transition-all scale-95">
                <div id="success-animation" class="text-8xl mb-4">ğŸ‰</div>
                <h2 id="success-message" class="text-3xl font-bold text-green-600">åšå¾—å¥½ï¼</h2>
                <button id="next-round-btn" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg text-lg">ä¸‹ä¸€å›åˆ</button>
            </div>
        </div>

        <!-- Staff Apology Modal -->
        <div id="staff-apology-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-lg shadow-2xl text-center transform transition-all animate-pop-in">
                <div class="text-8xl mb-4">ğŸ§‘â€ğŸ’¼</div>
                <h2 class="text-3xl font-bold text-amber-700">ä¸å¥½æ„æ€ï¼Œæ”¾éŒ¯äº†ï¼</h2>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const TONE_VOLUME = -10; // set volume to -10 decibels for softer sounds
            // --- DOM Elements ---
            const startScreen = document.getElementById('start-screen');
            const mainGame = document.getElementById('main-game');
            const endScreen = document.getElementById('end-screen');
            const startEasyBtn = document.getElementById('start-easy');
            const startDifficultBtn = document.getElementById('start-difficult');
            const restartGameBtn = document.getElementById('restart-game');
            const scoreEl = document.getElementById('score');
            const roundEl = document.getElementById('round');
            const listOwnerEl = document.getElementById('list-owner');
            const elevatorButtonsContainer = document.getElementById('elevator-buttons');
            const departmentFloor = document.getElementById('department-floor');
            const shoppingCartEl = document.getElementById('shopping-cart');
            const wrongItemsSection = document.getElementById('wrong-items-section');
            const wrongItemsCartEl = document.getElementById('wrong-items-cart');
            const successModal = document.getElementById('success-modal');
            const successMessageEl = document.getElementById('success-message');
            const nextRoundBtn = document.getElementById('next-round-btn');
            const finalScoreEl = document.getElementById('final-score');
            const staffApologyModal = document.getElementById('staff-apology-modal');

            // --- Sound Effects ---
            let soundsReady = false;
            let correctSound, wrongSound, winSound;

            function setupSounds() {
                correctSound = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 },
                    volume: TONE_VOLUME
                }).toDestination();

                wrongSound = new Tone.Synth({
                    oscillator: { type: "square" },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 },
                    volume: TONE_VOLUME
                }).toDestination();
                
                winSound = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.2, release: 0.1 },
                    volume: TONE_VOLUME
                }).toDestination();
                
                soundsReady = true;
            }

            function playCorrectSound() {
                if (!soundsReady) return;
                correctSound.triggerAttackRelease("C5", "8n");
            }
            
            function playWrongSound() {
                if(!soundsReady) return;
                wrongSound.triggerAttackRelease("C3", "8n", Tone.now());
            }

            function playWinSound() {
                if (!soundsReady) return;
                const now = Tone.now();
                winSound.triggerAttackRelease(["C5", "E5", "G5"], "8n", now);
                winSound.triggerAttackRelease(["G5", "C6"], "8n", now + 0.2);
            }

            // --- Game Data ---
            const storeData = {
                '5/F': { hypernym: 'é›»å™¨', items: [
                    { name: 'é›ªæ«ƒ', icon: 'images/fridge.png' }, { name: 'å¾®æ³¢çˆ', icon: 'images/microwave.png' }, { name: 'é›»é£¯ç…²', icon: 'images/ricecooker.png' }, { name: 'é›»ç£çˆ', icon: 'images/inductioncooker.png' }, 
                    { name: 'æŠ½æ²¹ç…™æ©Ÿ', icon: 'images/kitchenhood.png' }, { name: 'æ”ªæ‹Œæ©Ÿ', icon: 'images/blender.png' }, { name: 'æ´—è¡£æ©Ÿ', icon: 'images/washingmachine.png' }, { name: 'å¸å¡µæ©Ÿ', icon: 'images/vacuum.png' }, 
                    { name: 'å†·æ°£æ©Ÿ', icon: 'images/ac.png' }, { name: 'é¢¨æ‰‡', icon: 'images/fan.png' }, { name: 'é›»è¦–æ©Ÿ', icon: 'images/tv.png' }, { name: 'é›»è…¦', icon: 'images/computer.png' }, 
                    { name: 'å¹³æ¿é›»è…¦', icon: 'images/ipad.png' }, { name: 'æš–çˆ', icon: 'images/heater.png' }, { name: 'ç†¨æ–—', icon: 'images/iron.png' }, { name: 'é¢¨ç­’', icon: 'images/hairdryer.png' }
                ]},
                '4/F': { hypernym: 'æ–‡å…·', items: [
                    { name: 'åŸå­ç­†', icon: 'images/pen.png' }, { name: 'é‰›ç­†', icon: 'images/pencil.png' }, { name: 'è¢å…‰ç­†', icon: 'images/highlighter.png' }, { name: 'é–“å°º', icon: 'ğŸ“' }, 
                    { name: 'åœ“è¦', icon: 'images/compass.png' }, { name: 'å‰ªåˆ€', icon: 'images/scissors.png' }, { name: 'ç´™', icon: 'images/paper.png' }, { name: 'é‡˜æ›¸æ©Ÿ', icon: 'images/stapler.png' }, 
                    { name: 'è¬å­—å¤¾', icon: 'images/paperclip.png' }, { name: 'æ–‡ä»¶å¤¾', icon: 'images/files.png' }, { name: 'æ¼¿ç³Šç­†', icon: 'images/gluestick.png' }, { name: 'è† ç´™', icon: 'images/cellotape.png' }, 
                    { name: 'å¡—æ”¹æ¶²', icon: 'images/tippex.png' }, { name: 'ä¾¿æ¢ç´™', icon: 'images/memo.png' }, { name: 'é¡è‰²ç­†', icon: 'images/colourpencil.png' }
                ]},
                '3/F': { hypernym: 'å®¶å±…ç”¨å“', items: [
                    { name: 'æƒæŠŠ', icon: 'images/broom.png' }, { name: 'æ´—æ‰‹æ¶²', icon: 'images/soap.png' }, { name: 'åˆ€å‰', icon: 'ğŸ´' }, 
                    { name: 'ä¿é®®ç›’', icon: 'images/tupperware.png' }, { name: 'æ•é ­', icon: 'images/pillow.png' }, { name: 'æ£‰è¢«', icon: 'images/futon.png' }, 
                    { name: 'è¡£æ¶', icon: 'images/hanger.png' }, { name: 'çª—ç°¾', icon: 'images/curtain.png' }, { name: 'åœ°æ°ˆ', icon: 'images/carpet.png' }
                ]},
                '2/F': { hypernym: 'æœé£¾', items: [
                    { name: 'Tè£‡', icon: 'ğŸ‘•' }, { name: 'è£‡è¡«', icon: 'ğŸ‘”' }, { name: 'ç‰›ä»”è¤²', icon: 'ğŸ‘–' }, { name: 'è£™', icon: 'ğŸ‘—' }, 
                    { name: 'å¤–å¥—', icon: 'ğŸ§¥' }, { name: 'è¥ª', icon: 'ğŸ§¦' }, { name: 'å¸½', icon: 'ğŸ§¢' }, { name: 'æ³¢é‹', icon: 'ğŸ‘Ÿ' }, 
                    { name: 'æ‰‹è¢‹', icon: 'ğŸ‘œ' }, { name: 'é ¸å·¾', icon: 'ğŸ§£' }, { name: 'äººå­—æ‹–', icon: 'ğŸ©´' }, { name: 'é´', icon: 'ğŸ‘¢' }
                ]},
                '1/F': { hypernym: 'å‚¢ä¿¬', items: [
                    { name: 'åºŠ', icon: 'images/bed.png' }, { name: 'æ¢³åŒ–', icon: 'images/sofa.png' }, { name: 'é£Ÿé£¯æ±', icon: 'images/table.png' }, { name: 'æ¤…å­', icon: 'images/chair.png' }, 
                    { name: 'æ›¸æ«ƒ', icon: 'images/bookcase.png' }, { name: 'è¡£æ«ƒ', icon: 'images/wardrobe.png' }, { name: 'é‹æ«ƒ', icon: 'images/shoecabinet.png' },
                    { name: 'æ›¸æ±', icon: 'images/desk.png' }
                ]},
                'G/F': { hypernym: 'é£Ÿç‰©', items: [
                    { name: 'è˜‹æœ', icon: 'ğŸ' }, { name: 'æ¢¨', icon: 'ğŸ' }, { name: 'æª¸æª¬', icon: 'ğŸ‹' }, { name: 'é¦™è•‰', icon: 'ğŸŒ' }, 
                    { name: 'è¥¿ç“œ', icon: 'ğŸ‰' }, { name: 'æå­', icon: 'ğŸ‡' }, { name: 'å£«å¤šå•¤æ¢¨', icon: 'ğŸ“' }, { name: 'è—è“', icon: 'ğŸ«' }, 
                    { name: 'èœœç“œ', icon: 'ğŸˆ' }, { name: 'è»Šå˜å­', icon: 'ğŸ’' }, { name: 'æ¡ƒ', icon: 'ğŸ‘' }, { name: 'èŠ’æœ', icon: 'ğŸ¥­' }, 
                    { name: 'è è˜¿', icon: 'ğŸ' }, { name: 'æ¤°å­', icon: 'ğŸ¥¥' }, { name: 'å¥‡ç•°æœ', icon: 'ğŸ¥' }, { name: 'èŒ„å­', icon: 'ğŸ†' }, 
                    { name: 'ç•ªèŒ„', icon: 'ğŸ…' }, { name: 'ç‰›æ²¹æœ', icon: 'ğŸ¥‘' }, { name: 'è¥¿è˜­èŠ±', icon: 'ğŸ¥¦' }, { name: 'é’ç“œ', icon: 'ğŸ¥’' }, 
                    { name: 'è¾£æ¤’', icon: 'ğŸŒ¶ï¸' }, { name: 'èœ', icon: 'ğŸ¥¬' }, { name: 'ç²Ÿç±³', icon: 'ğŸŒ½' }, { name: 'ç´…è˜¿è””', icon: 'ğŸ¥•' }, 
                    { name: 'è’œé ­', icon: 'ğŸ§„' }, { name: 'æ´‹è‘±', icon: 'ğŸ§…' }, { name: 'è–¯ä»”', icon: 'ğŸ¥”' }, { name: 'ç•ªè–¯', icon: 'ğŸ ' }, 
                    { name: 'è–‘', icon: 'ğŸ«š' }, { name: 'è›‹ç³•', icon: 'ğŸ°' }, { name: 'éºµåŒ…', icon: 'ğŸ' }, { name: 'é›ªç³•', icon: 'ğŸ¦' }, 
                    { name: 'æ›²å¥‡é¤…', icon: 'ğŸª' }, { name: 'æ³¢æ¿ç³–', icon: 'ğŸ­' }, { name: 'æœ±å¤åŠ›', icon: 'ğŸ«' }, { name: 'ç½é ­', icon: 'ğŸ¥«' }, { name: 'è‚‰', icon: 'ğŸ¥©' }
                ]}
            };
            
            const allItemObjects = Object.values(storeData).flatMap(floor => floor.items);
            const itemMap = new Map(allItemObjects.map(item => [item.name, item]));
            const allItems = allItemObjects.map(item => item.name);
            const relatives = ['åª½åª½', 'çˆ¸çˆ¸', 'å§å§', 'å¼Ÿå¼Ÿ', 'ä¼¯ä¼¯', 'å§¨å§¨', 'å°ç‹—', 'å°è²“'];
            const relativeIcons = {
                'åª½åª½': 'ğŸ‘©', 'çˆ¸çˆ¸': 'ğŸ‘¨', 'å§å§': 'ğŸ‘§', 'å¼Ÿå¼Ÿ': 'ğŸ‘¦', 'ä¼¯ä¼¯': 'ğŸ‘¨â€ğŸ’¼', 'å§¨å§¨': 'ğŸ‘©â€ğŸ’¼', 'å°ç‹—': 'ğŸ¶', 'å°è²“': 'ğŸ±'
            };

            // --- Game State ---
            let gameState = {
                difficulty: 'easy',
                currentRound: 1,
                score: 0,
                activeFloor: 'G/F',
                shoppingList: [],
                itemsInCart: [],
                wrongItemsFound: [],
                misplacedItemsOnFloors: {},
                wrongPresses: 0
            };

            // --- Functions ---
            function startGame(difficulty) {
                // Initialize Tone.js on user interaction
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
                setupSounds();

                gameState.difficulty = difficulty;
                gameState.currentRound = 1;
                gameState.score = 0;
                updateScore(0);
                startScreen.classList.add('hidden');
                endScreen.classList.add('hidden');
                mainGame.classList.remove('hidden');

                if (difficulty === 'difficult') {
                    wrongItemsSection.classList.remove('hidden');
                } else {
                    wrongItemsSection.classList.add('hidden');
                }

                setupRound();
            }

            function setupRound() {
                updateRoundDisplay();
                gameState.shoppingList = [];
                gameState.itemsInCart = [];
                gameState.wrongItemsFound = [];
                gameState.misplacedItemsOnFloors = {};
                gameState.wrongPresses = 0;

                // Generate shopping list
                const listOwner = relatives[gameState.currentRound - 1];
                listOwnerEl.textContent = `${listOwner} çš„æ¸…å–®ï¼š`;
                const listSize = gameState.difficulty === 'difficult' ? 3 : (Math.random() < 0.7 ? 2 : 3); // 3 items for difficult, 2-3 for easy
                const availableItems = [...allItems];
                for (let i = 0; i < listSize; i++) {
                    const randomIndex = Math.floor(Math.random() * availableItems.length);
                    gameState.shoppingList.push(availableItems.splice(randomIndex, 1)[0]);
                }

                // Generate 4 misplaced items for difficult mode on random floors
                if (gameState.difficulty === 'difficult') {
                    const allFloorKeys = Object.keys(storeData);
                    // Shuffle floors to pick 4 random ones
                    for (let i = allFloorKeys.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [allFloorKeys[i], allFloorKeys[j]] = [allFloorKeys[j], allFloorKeys[i]];
                    }
                    const floorsToMuddle = allFloorKeys.slice(0, 4); // Select 4 floors

                    floorsToMuddle.forEach(floorKey => {
                        const floorItems = storeData[floorKey].items;
                        const otherItems = allItemObjects.filter(itemObj => !floorItems.some(floorItem => floorItem.name === itemObj.name));
                        const wrongItem = otherItems[Math.floor(Math.random() * otherItems.length)];
                        gameState.misplacedItemsOnFloors[floorKey] = wrongItem;
                    });
                }

                renderElevator();
                changeFloor('G/F');
                updateCart();
            }
            
            function renderElevator() {
                elevatorButtonsContainer.innerHTML = '';
                const floors = Object.keys(storeData).reverse(); // 5/F on top
                floors.forEach(floorKey => {
                    const floorData = storeData[floorKey];
                    const button = document.createElement('button');
                    button.className = `elevator-button w-full text-center p-2 rounded-lg font-semibold transition-colors duration-200 bg-gray-200 hover:bg-amber-400`;
                    button.dataset.floor = floorKey;
                    
                    button.innerHTML = `
                        <span class="block text-lg">${floorKey}</span>
                        <span class="block text-sm">${floorData.hypernym}</span>
                    `;
                    
                    if (floorKey === gameState.activeFloor) {
                        button.classList.add('active');
                    }
                    button.addEventListener('click', () => changeFloor(floorKey));
                    elevatorButtonsContainer.appendChild(button);
                });
            }

            function changeFloor(floorKey) {
                gameState.activeFloor = floorKey;
                renderElevator(); // To update active button
                renderFloor(floorKey);
            }

            function renderFloor(floorKey) {
                const floorData = storeData[floorKey];
                let itemsToDisplay = [...floorData.items];
                
                if (gameState.difficulty === 'difficult' && gameState.misplacedItemsOnFloors[floorKey]) {
                    const wrongItem = gameState.misplacedItemsOnFloors[floorKey];
                    
                    const replaceableItems = itemsToDisplay.filter(item => !gameState.shoppingList.includes(item.name));

                    if (replaceableItems.length > 0) {
                        const itemToReplace = replaceableItems[Math.floor(Math.random() * replaceableItems.length)];
                        const indexToReplace = itemsToDisplay.findIndex(item => item.name === itemToReplace.name);
                        
                        if (indexToReplace !== -1) {
                            itemsToDisplay[indexToReplace] = wrongItem;
                        }
                    } else {
                        const randomIndex = Math.floor(Math.random() * itemsToDisplay.length);
                        itemsToDisplay[randomIndex] = wrongItem;
                    }
                }

                itemsToDisplay.sort(() => Math.random() - 0.5);

                departmentFloor.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-amber-800">${floorKey} - ${floorData.hypernym}</h2>
                    </div>
                    <div id="shelves" class="space-y-8"></div>
                `;

                const shelvesContainer = document.getElementById('shelves');
                const itemsPerShelf = window.innerWidth < 768 ? 3 : 5; 
                let shelfCount = 0;

                for (let i = 0; i < itemsToDisplay.length; i += itemsPerShelf) {
                    shelfCount++;
                    const shelfItems = itemsToDisplay.slice(i, i + itemsPerShelf);
                    
                    const shelfWrapper = document.createElement('div');
                    shelfWrapper.className = 'shelf-wrapper';

                    const itemsDiv = document.createElement('div');
                    itemsDiv.className = 'grid gap-2 sm:gap-4 justify-items-center';
                    itemsDiv.style.gridTemplateColumns = `repeat(${shelfItems.length}, minmax(0, 1fr))`;

                    shelfItems.forEach(item => {
                        const isCollected = gameState.itemsInCart.includes(item.name) || gameState.wrongItemsFound.includes(item.name);
                        const card = document.createElement('div');
                        card.className = `item-card cursor-pointer bg-white rounded-lg p-2 text-center border-2 border-transparent ${isCollected ? 'selected' : ''}`;
                        card.dataset.item = item.name;
                        
                        const isImagePath = item.icon.includes('/');
                        let iconHTML;

                        if (isImagePath) {
                            iconHTML = `<img src="${item.icon}" alt="${item.name}" class="max-w-full max-h-full object-contain">`;
                        } else {
                            iconHTML = `<span class="text-5xl sm:text-6xl">${item.icon}</span>`;
                        }
                        
                        const iconContainerHTML = `
                            <div class="bg-gray-100 rounded-md flex items-center justify-center aspect-square w-24 h-24 mx-auto p-2">
                                ${iconHTML}
                            </div>`;

                        card.innerHTML = `
                            ${iconContainerHTML}
                            <p class="mt-2 text-sm sm:text-base font-medium text-gray-700">${item.name}</p>
                        `;

                        card.addEventListener('click', () => handleItemClick(item.name, card));
                        itemsDiv.appendChild(card);
                    });
                    
                    shelfWrapper.appendChild(itemsDiv);

                    const shelfDiv = document.createElement('div');
                    shelfDiv.className = 'shelf h-5 mt-1';
                    shelfWrapper.appendChild(shelfDiv);

                    shelvesContainer.appendChild(shelfWrapper);
                }
            }
            
            function handleItemClick(itemName, cardElement) {
                if (cardElement.classList.contains('selected')) return; 

                const isOnShoppingList = gameState.shoppingList.includes(itemName);
                const isMisplaced = gameState.difficulty === 'difficult' && Object.values(gameState.misplacedItemsOnFloors).some(itemObj => itemObj.name === itemName);
                const isCorrectOnThisFloor = storeData[gameState.activeFloor].items.some(item => item.name === itemName);

                if (gameState.difficulty === 'easy') {
                    if (isOnShoppingList) {
                        gameState.itemsInCart.push(itemName);
                        updateScore(10);
                        playCorrectSound();
                        cardElement.classList.add('selected');
                    } else {
                        playWrongSound();
                    }
                } else { // Difficult mode
                    if (isOnShoppingList && isCorrectOnThisFloor) {
                        gameState.itemsInCart.push(itemName);
                        updateScore(10);
                        playCorrectSound();
                        cardElement.classList.add('selected');
                    } else if (isMisplaced && !isCorrectOnThisFloor) {
                        gameState.wrongItemsFound.push(itemName);
                        updateScore(15);
                        playCorrectSound();
                        cardElement.classList.add('selected');
                        showStaffApology();
                        gameState.wrongPresses = 0; // Reset hint counter on correct find
                    } else {
                         updateScore(-5); 
                         playWrongSound();
                         gameState.wrongPresses++;
                         if (gameState.wrongPresses >= 3) {
                             showHint();
                             gameState.wrongPresses = 0; // Reset after showing hint
                         }
                    }
                }

                updateCart();
                checkRoundCompletion();
            }

            function updateCart() {
                const listOwner = relatives[gameState.currentRound - 1];
                const ownerIcon = relativeIcons[listOwner];

                listOwnerEl.innerHTML = `<span class="text-2xl">${ownerIcon}</span> ${listOwner} çš„æ¸…å–®ï¼š <span class="font-normal">${gameState.shoppingList.map(item => `<span class="${gameState.itemsInCart.includes(item) ? 'text-green-500 line-through' : ''}">${item}</span>`).join('ã€')}</span>`;
                
                if (gameState.itemsInCart.length === 0) {
                    shoppingCartEl.innerHTML = '<p class="text-gray-500 text-center italic">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>';
                } else {
                    shoppingCartEl.innerHTML = gameState.itemsInCart.map(item => {
                        const itemData = itemMap.get(item);
                        const isImagePath = itemData.icon.includes('/');
                        const iconContent = isImagePath
                            ? `<img src="${itemData.icon}" alt="${itemData.name}" class="w-6 h-6 object-contain">`
                            : `<span class="text-2xl">${itemData.icon}</span>`;
                        return `<div class="bg-green-100 text-green-800 p-2 rounded-md flex items-center justify-center gap-2">${iconContent}<span>${itemData.name}</span></div>`
                    }).join('');
                }

                if (gameState.difficulty === 'difficult') {
                    if (gameState.wrongItemsFound.length === 0) {
                        wrongItemsCartEl.innerHTML = '<p class="text-gray-500 text-center italic">é‚„æœªæ‰¾åˆ°</p>';
                    } else {
                        wrongItemsCartEl.innerHTML = gameState.wrongItemsFound.map(item => {
                            const itemData = itemMap.get(item);
                             const isImagePath = itemData.icon.includes('/');
                            const iconContent = isImagePath
                                ? `<img src="${itemData.icon}" alt="${itemData.name}" class="w-6 h-6 object-contain">`
                                : `<span class="text-2xl">${itemData.icon}</span>`;
                            return `<div class="bg-red-100 text-red-800 p-2 rounded-md flex items-center justify-center gap-2">${iconContent}<span>${itemData.name}</span></div>`
                        }).join('');
                    }
                }
            }

            function updateScore(change) {
                gameState.score += change;
                if (gameState.score < 0) gameState.score = 0;
                scoreEl.textContent = gameState.score;
                scoreEl.classList.add('score-pop');
                setTimeout(() => scoreEl.classList.remove('score-pop'), 300);
            }

            function updateRoundDisplay() {
                 roundEl.textContent = `${gameState.currentRound} / 8`;
            }

            function checkRoundCompletion() {
                let roundComplete = false;
                if (gameState.difficulty === 'easy') {
                    if (gameState.shoppingList.every(item => gameState.itemsInCart.includes(item))) {
                        roundComplete = true;
                    }
                } else { // Difficult
                    const allShoppingItemsFound = gameState.shoppingList.every(item => gameState.itemsInCart.includes(item));
                    const allMisplacedItemsFound = Object.values(gameState.misplacedItemsOnFloors).every(item => gameState.wrongItemsFound.includes(item.name));
                    if (allShoppingItemsFound && allMisplacedItemsFound) {
                        roundComplete = true;
                    }
                }
                
                if (roundComplete) {
                    playWinSound();
                    updateScore(20);
                    setTimeout(() => {
                        showSuccessModal();
                    }, 500);
                }
            }

            function showSuccessModal() {
                if (gameState.currentRound === 8) {
                    successMessageEl.textContent = "ä»»å‹™å®Œæˆï¼";
                    nextRoundBtn.textContent = "æŸ¥çœ‹çµæœ";
                } else {
                    successMessageEl.textContent = "åšå¾—å¥½ï¼";
                    nextRoundBtn.textContent = "ä¸‹ä¸€å›åˆ";
                }
                successModal.classList.remove('hidden');
            }

            function showStaffApology() {
                staffApologyModal.classList.remove('hidden');
                setTimeout(() => {
                    staffApologyModal.classList.add('hidden');
                }, 1500);
            }
            
            function nextRound() {
                successModal.classList.add('hidden');
                if (gameState.currentRound < 8) {
                    gameState.currentRound++;
                    setupRound();
                } else {
                    showEndScreen();
                }
            }

            function showEndScreen() {
                mainGame.classList.add('hidden');
                finalScoreEl.textContent = gameState.score;
                endScreen.classList.remove('hidden');
            }

            function resetGame() {
                endScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            }

            function showHint() {
                const unfoundFloors = Object.keys(gameState.misplacedItemsOnFloors).filter(floorKey => {
                    const misplacedItemName = gameState.misplacedItemsOnFloors[floorKey].name;
                    return !gameState.wrongItemsFound.includes(misplacedItemName);
                });

                if (unfoundFloors.length > 0) {
                    const hintFloor = unfoundFloors[0];
                    const hintButton = elevatorButtonsContainer.querySelector(`[data-floor="${hintFloor}"]`);
                    if (hintButton) {
                        hintButton.classList.add('vibrate-hint');
                        setTimeout(() => {
                            hintButton.classList.remove('vibrate-hint');
                        }, 1500);
                    }
                }
            }

            // --- Event Listeners ---
            startEasyBtn.addEventListener('click', () => startGame('easy'));
            startDifficultBtn.addEventListener('click', () => startGame('difficult'));
            restartGameBtn.addEventListener('click', resetGame);
            nextRoundBtn.addEventListener('click', nextRound);
            
            let lastRenderedWidth = window.innerWidth;

             // Responsive layout adjustment
            window.addEventListener('resize', () => {
                if (!mainGame.classList.contains('hidden')) {
                    const currentWidth = window.innerWidth;
                    const breakpoint = 768;
                    const crossedBreakpoint = (lastRenderedWidth < breakpoint && currentWidth >= breakpoint) || (lastRenderedWidth >= breakpoint && currentWidth < breakpoint);
                    
                    if (crossedBreakpoint) {
                        renderFloor(gameState.activeFloor);
                    }
                    
                    lastRenderedWidth = currentWidth; 
                }
            });
        });
    </script>
</body>
</html>


